<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html>
<head>
<title>Usare le DLL</title>
<link href="style.css" rel="stylesheet" type="text/css">
</head>
<body background="images/back.gif">
<!--START-->

<h1>Usare le DLL</h1>

<i><b>Questa funzionalità è disponibile sono nella Standard Edition di Game Maker.</b></i>


<p>
<i><b>Ricorda che dalla versione 7 c'è un nuovo meccanismo per le estensioni.
È meglio utilizzare il meccanismo delle estensioni, piuttosto che le funzioni
descritte in questa sezione.
Vedi
<a href="http://www.yoyogames.com/extensions" target="_blank">http://www.yoyogames.com/extensions</a>
per i dettagli.
Queste funzioni vengono mantenute principalmente per compatibilità
con il passato.</b></i>


<p>
In quei casi in cui le funzionalità del GML non sono sufficienti,
puoi estendere le possibilità usando i plug-ins. Un plug-in
nella forma di file DLL (una libreria a collegamento dinamico. In un file DLL
puoi definire delle funzioni. Queste funzioni possono essere scritte in qualunque
linguaggio di programmazione che supporta la creazione di DLL (Delphi, C, C++, ecc.)
Dovrai comunque aver bisogno di esperienza con la programmazione per fare ciò.
Le funzioni esterne devono avere un formato specifico. Possono avere da 0 a 16
argomenti, ognuno dei quali può essere un numero reale (double sul C) oppure
una stringa null-terminated (che termina con il carattere \0). (Per più di 4 argomenti,
sono supportati solo i numeri reali al momento). Esse devono ritornare
un numero reale o una stringa null-terminated.

<p>
Nel Delphi puoi creare una DLL scegliendo prima <b>New</b>
dal menu <b>File</b> e dopo scegliere DLL. Qui
c'è un esempio di una DLL che puoi usare con <i>GameMaker</i>
scritto in Delphi. (Nota che questo è del codice Delphi,
non GML!)

<p>
<blockquote>
<pre>
library MyDLL;

uses SysUtils, Classes;

function MyMin(x,y:double):double;  cdecl;
begin
  if x&lt;y then Result := x else Result := y;
end;

var res : array[0..1024] of char;

function DoubleString(str:PChar):PChar; cdecl;
begin
  StrCopy(res,str);
  StrCat(res,str);
  Result := res;
end;

exports MyMin, DoubleString;

begin
end.
</pre>
</blockquote>

<p>
Questa DLL definisce due funzioni: <tt>MyMin</tt> prende due argomenti reali
e restituisce il minore tra i due, e <tt>DoubleString</tt>
raddoppia la stringa. Nota che devi fare attenzione con la gestione della memoria.
Questo è il motivo per cui ho dichiarato la stringa risultante globale.
Inoltre ricorda l'uso della convezione per le chiamate "cdecl". Puoi
usare sia cdecl che stdcall. Dopo che hai creato
la DLL in Delphi otterrai un file chiamato <tt>MyDLL.DLL</tt>. Questo
file dev'essere piazzato nella directory di esecuzione del tuo gioco.
(O in qualunque altro posto in cui Windows può trovarlo).

<p>
Per usare questa DLL su <i>GameMaker</i> devi prima specificare
le funzioni esterne che vuoi utilizzare e quali tipi di argomenti
prendono. Per questo c'è la seguente funzione GML:

<p>
<blockquote>
  <tt><b>external_define(dll,name,calltype,restype,argnumb,arg1type,arg2type, ...)</b></tt> 
	Definisce una funzione esterna. dll è il nome del file DLL.
	name è il nome della funzione. calltype è la convenzione per le chiamate
	da usare. Per questa puoi mettere sia dll_cdecl che dll_stdcall. restype è
	il tipo del risultato. Per questo puoi usare ty_real o ty_string. argnumb
	è il numero di argomenti (0-16). Poi, per ogni argomento devi
	specificare il suo tipo, usando ty_real o ty_string.
	Quando ci sono più di 4 argomenti, devono essere tutti ty_real.<br>
</blockquote>

<p>
This function returns the id of the external function that 
must be used for calling it. So in the above example, at the 
start of the game you would use the following GML code:

<p>
<blockquote>
<pre>
{
  global.mmm = external_define('MyDLL.DLL','MyMin',dll_cdecl,
                                     ty_real,2,ty_real,ty_real);
  global.ddd = external_define('MyDLL.DLL','DoubleString',dll_cdecl,
                                     ty_string,1,ty_string);
}
</pre>
</blockquote>

<p>
Now whenever you need to call the functions, you use the following function:

<p>
<blockquote>
  <tt><b>external_call(id,arg1,arg2,...)</b></tt> 
    Calls the external function with the given id, and the given 
	arguments. You need to provide the correct number of arguments 
	of the correct type (real or string). The function returns
	the result of the external function.<br>
</blockquote>

<p>
So, for example, you would write:

<p>
<blockquote>
<pre>
{
  aaa = external_call(global.mmm,x,y);
  sss = external_call(global.ddd,'Hello');
}
</pre>
</blockquote>

<p>
If you don't need to use the DLL anymore you had better free it.

<p>
<blockquote>
  <tt><b>external_free(dll)</b></tt> 
    Frees the DLL with the given name. This is in particular necessary if the 
	game should remove the DLL. As long as the DLL is not freed it cannot be 
	removed. Best do this e.g. in an end of game event.<br>
</blockquote>

<p>
You might wonder how to make a function in a DLL that does 
something in the game. For example, you might want to create 
a DLL that adds instances of objects to your game. The easiest 
way is to let your DLL function return a string that 
contains a piece of GML code. This string that contains 
the piece of GML can be executed using the GML function

<p>
<blockquote>
  <tt><b>execute_string(str,arg0,arg1,...)</b></tt> 
    Execute the piece of code in the string str with the indicated arguments.<br>
</blockquote>

<p>
Alternatively you can let the DLL create a file with a 
script that can be executed (this function can also be 
used to later modify the behavior of a game).

<p>
<blockquote>
  <tt><b>execute_file(fname)</b></tt> 
    Execute the piece of code in the file.<br>
</blockquote>

<p>
Now you can call an external function and then execute the resulting string, e.g. as follows:

<p>
<blockquote>
<pre>
{
  ccc = external_call(global.ddd,x,y);
  execute_string(ccc);
}
</pre>
</blockquote>

<p>
In some rare cases your DLL might need to know the handle of the main
graphics window for the game. This can be obtained with the following 
function and can then be passed to the DLL:

<p>
<blockquote>
  <tt><b>window_handle()</b></tt> 
    Returns the window handle for the main window.<br>
</blockquote>

<p>
Note that DLLs cannot be used in secure mode.

<p>
Using external DLLs is an extremely powerful mechanism. 
But please only use it if you know what you are doing.

<p>
<blockquote>
  <tt><b>get_function_address('function_name')</b></tt> 
    Returns the address of a GameMaker function. This can be passed to DLL's so the can call directly into GameMaker.<br>
	This feature is unsuported, so care must be taken when using this function.<br>
	<b>Please Note: These functions use Delphi 2010 PASCAL calling convention and string formats.</b><br>
</blockquote>


<!--END-->
</body>
</html>

<!-- KEYWORDS
DLL
plug-in
external functions
Delphi
C++
extending GameMaker
adding functionality
window handle
executing strings
executing external scripts
executing files

external_call()
external_define()
external_free()
window_handle()
get_function_address()
ty_real
ty_string
dll_cdecl
dll_stdcall
--> 
